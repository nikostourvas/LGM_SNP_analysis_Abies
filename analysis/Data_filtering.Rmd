---
title: "LifeGenMon Abies SNP analysis - Data filtering options"
author: "Nikos Tourvas"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
bibliography: library.bib
output:
  html_notebook:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
    toc_depth: 3
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    ## toc_float: yes
  pdf_document:
    toc: yes
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

```{r}
source("import_snp_abies.R")
source("barplot_missing.R")
source("barplot_N_alleles.R")
```


# Case 1

```{r}
threshold_loci <- 0.1
threshold_ind <- 0.1
maf <- 0.05

obj <- import.snp.abies(threshold_loci = threshold_loci,
                        threshold_ind = threshold_ind,
                        maf = maf)
```

### Data filtering thresholds
```{r include=T}
paste("SNP loci:", threshold_loci*100, 
      "% missing data across populations", sep=" ")
yintercept = 20

paste("Individuals:", threshold_ind*100, "% missing data", sep=" ")


paste("SNP loci with minor allele frequency <", maf)
```

```{r include=T}
### Data set details after data filtering:

paste(nInd(obj), "individuals", "and", nLoc(obj), "loci", sep=" ")
```

```{r, include=T}
barplot.missing(obj)
```

```{r cache=T, dpi=300, fig.width=5, fig.height=3, include=T}
a1 <- barplot.N.alleles(obj)
a1$plot
```

```{r}
private <- poppr::private_alleles(obj, report = "data.frame")

if(is.data.frame(private)){
  
ggplot(private) + geom_tile(aes(x = population,
                                y = allele,
                                fill = count)) +
  ggtitle("Private alleles per population") +
  scale_fill_viridis_c()
  
}
```

```{r}
setPop(obj) <- ~Country

private <- poppr::private_alleles(obj, 
                                  report = "data.frame")


if(is.data.frame(private)){

ggplot(private) + geom_tile(aes(x = population,
                                y = allele,
                                fill = count)) +
  ggtitle("Private alleles per cohort") +
  scale_fill_viridis_c()
  
}

setPop(obj) <- ~Country/Pop
```



# Case 2 - No MAF filter

```{r}
threshold_loci <- 0.1
threshold_ind <- 0.1
maf <- 0

obj <- import.snp.abies(threshold_loci = threshold_loci,
                        threshold_ind = threshold_ind,
                        maf = maf)
```

### Data filtering thresholds
```{r include=T}
paste("SNP loci:", threshold_loci*100, 
      "% missing data across populations", sep=" ")


paste("Individuals:", threshold_ind*100, "% missing data", sep=" ")


paste("SNP loci with minor allele frequency <", maf)
```

```{r include=T}
### Data set details after data filtering:

paste(nInd(obj), "individuals", "and", nLoc(obj), "loci", sep=" ")
```

```{r, include=T}
barplot.missing(obj)
```

```{r cache=T, dpi=300, fig.width=5, fig.height=3, include=T}
a2 <- barplot.N.alleles(obj)
a2$plot
```

```{r}
private <- poppr::private_alleles(obj, report = "data.frame")

if(is.data.frame(private)){
  
ggplot(private) + geom_tile(aes(x = population,
                                y = allele,
                                fill = count)) +
  ggtitle("Private alleles per population") +
  scale_fill_viridis_c()
  
}
```

```{r}
setPop(obj) <- ~Country

private <- poppr::private_alleles(obj, 
                                  report = "data.frame")


if(is.data.frame(private)){

ggplot(private) + geom_tile(aes(x = population,
                                y = allele,
                                fill = count)) +
  ggtitle("Private alleles per cohort") +
  scale_fill_viridis_c()
  
}

setPop(obj) <- ~Country/Pop
```

```{r}
p <- private %>% 
  group_by(population) %>% 
  summarise(count = n())

setPop(obj) <- ~Country

private2 <- poppr::private_alleles(obj, 
                                  report = "data.frame",
                                  count.alleles = F)

ggplot(private2, aes(x=population, y=count)) +
  geom_bar(stat="identity")

```


In the previous 2 cases the missing data filter for SNP loci is applied on the whole data set (not for each population). This means that a 10% threshold will result in one or more populations ending up with higher percentage of missing data than 10% for certain loci.

For the following 2 cases the missing data filter for SNP loci is applied for each population.

# Case 3

```{r}
threshold_loci <- 0.1
threshold_ind <- 0.1
maf <- 0.05

obj <- import.snp.abies2(threshold_loci = threshold_loci,
                        threshold_ind = threshold_ind,
                        maf = maf)
```

### Data filtering thresholds
```{r include=T}
paste("SNP loci:", threshold_loci*100, 
      "% missing data across populations", sep=" ")


paste("Individuals:", threshold_ind*100, "% missing data", sep=" ")


paste("SNP loci with minor allele frequency <", maf)
```

```{r include=T}
### Data set details after data filtering:

paste(nInd(obj), "individuals", "and", nLoc(obj), "loci", sep=" ")
```

```{r, include=T}
barplot.missing(obj)
```

```{r cache=T, dpi=300, fig.width=5, fig.height=3, include=T}
a3 <- barplot.N.alleles(obj)
a3$plot
```

# Case 4 - No MAF filter

```{r}
threshold_loci <- 0.1
threshold_ind <- 0.1
maf <- 0

obj <- import.snp.abies2(threshold_loci = threshold_loci,
                        threshold_ind = threshold_ind,
                        maf = maf)
```

### Data filtering thresholds
```{r include=T}
paste("SNP loci:", threshold_loci*100, 
      "% missing data across populations", sep=" ")


paste("Individuals:", threshold_ind*100, "% missing data", sep=" ")


paste("SNP loci with minor allele frequency <", maf)
```

```{r include=T}
### Data set details after data filtering:

paste(nInd(obj), "individuals", "and", nLoc(obj), "loci", sep=" ")
```

```{r, include=T}
barplot.missing(obj)
```

```{r cache=T, dpi=300, fig.width=5, fig.height=3, include=T}
a4 <- barplot.N.alleles(obj)
a4$plot
```
